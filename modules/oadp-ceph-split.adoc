// Module included in the following assemblies:
//
// * backup_and_restore/application_backup_and_restore/backing_up_and_restoring/backing-up-applications.adoc

:_content-type: PROCEDURE
[id="oadp-ceph-preparing-crs_{context}"]
= Backing up and restoring data using OADP 1.2 Data Mover and split volumes (CephFS and Ceph RBD)

You can use OpenShift API for Data Protection (OADP) 1.2 Data Mover to back up and restore data in an environment that has _split volumes_, that is, an environment that uses both CephFS and CephRBD.

// [IMPORTANT]
// ====
// The CephFS shallow copy feature can only be used for Data Mover backup operations.  The shallow copy volume options are not supported for restore.
// ====

.Prerequisites

* Ensure a stateful application is running in a separate namespace with PVCs provisioned by both CephFS and CephRBD.

* CephFS is the default `StorageClass` and `VolumeSnapshotClass`.

Procedure

. Create a Data Protection Application (DPA) CR similar to one below. Use the Restic `Secret` you created when you prepared your environment for working with OADP 1.2 Data Mover and Ceph as the value for `spec.features.dataMover.credentialName`. If you do not, then the CR will use the default value `dm-credential` for this parameter.
+
[NOTE]
====
`VolumeOptionsForStorageClass` can be defined for multiple `storageClasses`, thus allowing a backup to complete with volumes with different providers.
====
+
Example DPA CR for environment with split volumes
+
[source,yaml]
----
apiVersion: oadp.openshift.io/v1alpha1
kind: DataProtectionApplication
metadata:
  name: velero-sample
  namespace: openshift-adp
spec:
  backupLocations:
    - velero:
        config:
          profile: default
          region: us-east-1
        credential:
          key: cloud
          name: cloud-credentials
        default: true
        objectStorage:
          bucket: <my-bucket>
          prefix: velero
        provider: aws
  configuration:
    restic:
      enable: false
    velero:
      defaultPlugins:
        - openshift
        - aws
        - csi
        - vsm
  features:
    dataMover:
      credentialName: <restic-secret-name>
      enable: true
      volumeOptionsForStorageClasses:
        ocs-storagecluster-cephfs:
          sourceVolumeOptions:
            accessMode: ReadOnlyMany
            cacheAccessMode: ReadWriteMany
            cacheStorageClassName: ocs-storagecluster-cephfs
            storageClassName: ocs-storagecluster-cephfs-shallow
        ocs-storagecluster-ceph-rbd:
          sourceVolumeOptions:
            storageClassName: ocs-storagecluster-ceph-rbd
            cacheStorageClassName: ocs-storagecluster-ceph-rbd
        destinationVolumeOptions:
            storageClassName: ocs-storagecluster-ceph-rbd
            cacheStorageClassName: ocs-storagecluster-ceph-rbd
----

. To back up data:

.. Create a `Backup` CR:
+
Example `Backup` CR
+
[source,yaml]
----
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: <backup-name>
  namespace: <protected-ns>
spec:
  includedNamespaces:
- <app-ns>
storageLocation: velero-sample-1
----

.. Monitor the Data Mover backup and its artifacts by running the script named link:https://github.com/openshift/oadp-operator/blob/master/docs/examples/datamover_resources.sh[Volumemover live debug]
.. To check the progress of all the `VolumeSnapshotBackup` CRs, run the following command:
+
[source, terminal]
----
$ oc get vsb -n <app-ns>
----

.. To check the progress of a specific `VolumeSnapshotBackup` CR, run the following command:
+
[source,terminal]
----
$ oc get vsb <vsb-name> -n <app-ns> -ojsonpath="{.status.phase}`
----

.. Wait several minutes and check if the `VolumeSnapshotBackup` CR has the status `Completed`.
.. Verify that is at least one snapshot in the object store that is given in the Restic `secret`. You can check for this snapshot in your targeted `BackupStorageLocation` that has a prefix of `/<OADP-namespace>`.

. To restore data:

.. Verify that the application namespace is deleted, as well as any `VolumeSnapshotContent` CRs that were created during backup.

.. Create a `Restore` CR:
+
Example `Restore` CR
+
[source,yaml]
----
apiVersion: velero.io/v1
kind: Restore
metadata:
  name: <restore-name>
  namespace: <protected-ns>
spec:
  backupName: <previous-backup-name>
----

.. Monitor the Data Mover backup and its artifacts by running the script named link:https://github.com/openshift/oadp-operator/blob/master/docs/examples/datamover_resources.sh[Volumemover live debug]
.. To check the progress of all the `VolumeSnapshotRestore` CRs, run the following command:
+
[source, terminal]
----
$ oc get vsr -n <app-ns>
----

.. To check the progress of a specific `VolumeSnapshotRestore` CR, run the following command:
+
[source,terminal]
----
$ oc get vsr <vsr-name> -n <app-ns> -ojsonpath="{.status.phase}
----

.. Verify that your application data has been restored:
+
[source,terminal]
----
$ oc get route <route-name> -n <app-ns> -ojsonpath="{.spec.host}"
----
